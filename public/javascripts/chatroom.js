var socket;var myUserName;var currentSeletedUserName = 'All';function enableMsgInput(enable) {  $('input#msg').prop('disabled', !enable);}function enableUsernameField(enable) {  $('input#userName').prop('disabled', !enable);}function appendNewMessage(msg) {  var html;  var appendTo = msg.source;  var messageSrc = msg.source == myUserName ? "Me" : msg.source  if ($('input#userName').val() === msg.source ) {	html = "<div class='msgDiv'><span class='myMsg'>" + messageSrc + " : " + msg.message + "</span>" +			"<span class='msgTime'>" + msg.messageTime + "</span></div>";	appendTo = msg.target;  } else if (msg.target == "All") {	html = "<div class='msgDiv'><span class='msg'>" + messageSrc + " : " + msg.message + "</span>" +			"<span class='msgTime'>" + msg.messageTime + "</span></div>";    appendTo = msg.target;  } else {    // It is a private message	html = "<div class='msgDiv'><span class='msg'>" + messageSrc + " : " + msg.message + "</span>" +			"<span class='msgTime'>" + msg.messageTime + "</span></div>";      }  $("#" + appendTo + "_msgWindow").append(html);    messageCount(msg);}function messageCount(msg) {	if (msg.source == myUserName || currentSeletedUserName == msg.target ) return;	var count = 1;	var uname = msg.target == "All" ? msg.target : msg.source;	if($("#" + uname + "_menu_count").length > 0) {		count = count + parseInt($("#" + uname + "_menu_count").html());		$("#" + uname + "_menu_count").html(count);		return;	}	$("#" + uname + "_menu_li").append( "<span id='" + uname + "_menu_count' class='msgCount'>" + count + "</span>");}function menuClick(e) {	if (currentSeletedUserName == $(e.target).html()) return;	currentSeletedUserName = $(e.target).html();	refreshMenu($(e.target)[0]);}function appendNewUser(uName, notify, msg) {	$('#menu-container').append("<li id='" + uName + "_menu_li'><a class='a_menu' id='" + uName + "_menu'>" + uName + "</a></li>");	$("#" + uName + "_menu").click(menuClick);   	$('#main-container').append("<div id='" + uName + "_msgWindow' class='msgWindow shadow hidden'></div></div>");  	if (notify && (myUserName !== uName) && (myUserName !== 'All')) {		$('#All_msgWindow').append("<div class='msgDiv'><span class='adminMsg'>==>" + uName + " just joined <==</span>" +									"<span class='msgTime'>" + msg.messageTime + "</span></div>");	}}function handleUserLeft(msg) {	$("#"+ msg.userName + "_menu_li").remove();	$("#"+ msg.userName + "_msgWindow").remove();	$('#All_msgWindow').append("<div class='msgDiv'><span class='adminMsg'>==>" + msg.userName + " Left <==</span>" +									"<span class='msgTime'>" + msg.messageTime + "</span></div>");}socket = io.connect(window.location.origin);function setFeedback(fb) {  $('span#feedback').html(fb);}function setUsername() {	myUserName = $('input#userName').val();    socket.emit('set username', $('input#userName').val(), function(data) { console.log('emit set username', data); });    console.log('Set user name as ' + $('input#userName').val());}function sendMessage() {    var trgtUser = $('.selected a')[0].innerHTML;    socket.emit('message',                 {                  "inferSrcUser": true,                  "source": "",                  "message": $('input#msg').val(),                  "target": trgtUser                });	$('input#msg').val("");}function setCurrentUsers(usersStr) {	$('#menu-container').html("");	appendNewUser('All', false)	JSON.parse(usersStr).forEach(function(name) {		if (myUserName !== name)			appendNewUser(name, false);	});	refreshMenu();}function refreshMenu(currentMenu) {	var found = false;	var elements = $(".a_menu");	var addClass;	var removeClass;	if (!currentMenu) currentMenu = $(".a_menu")[0];	for (i = 0; i < elements.length; i++) {		if(elements[i].innerHTML == currentMenu.innerHTML) {			elements[i].parentElement.classList.add('selected');			removeClass = "hidden";			addClass = "show";			$("#" + elements[i].innerHTML + "_menu_count").remove();			found = true;		} else {			elements[i].parentElement.classList.remove('selected');			removeClass = "show";			addClass = "hidden";		}		$("#" + elements[i].innerHTML + "_msgWindow").removeClass(removeClass);		$("#" + elements[i].innerHTML + "_msgWindow").addClass(addClass);	}}$(function() {  enableMsgInput(false);  socket.on('userJoined', function(msg) {	if (myUserName)		appendNewUser(msg.userName, true, msg);  });    socket.on('userLeft', function(msg) {	if (myUserName)		handleUserLeft(msg);  });  socket.on('message', function(msg) {	if (myUserName)		appendNewMessage(msg);  });  socket.on('welcome', function(msg) {	setFeedback("<span style='color: green'> Username available. You can begin chatting.</span>");	setCurrentUsers(msg.currentUsers)    enableMsgInput(true);	enableUsernameField(false);  });  socket.on('err', function(msg) {	  if (msg.userNameInUse) {		  setFeedback("<span style='color: red'> Username already in use. Try another name.</span>");	  } else {		setFeedback("<span style='color: red'>" + msg.message + "</span>");	  }  });    //$('input#userName').change(setUsername);  $('input#userName').keypress(function(e) {	  if (e.keyCode == 13) {		  setUsername();		  e.stopPropagation();		  e.stopped = true;		  e.preventDefault();	  }  });    $('#btnSendMsg').click(function(e) {	sendMessage();	  });});